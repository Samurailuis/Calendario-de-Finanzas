<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Master AI - V9.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --primary: #3b82f6; --accent: #a855f7; }
        body { background-color: #020617; color: #f1f5f9; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .dark-card { background-color: #0f172a; border: 1px solid #1e293b; }
        
        .tab-item { cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab-active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 800; background: rgba(59, 130, 246, 0.1); transform: translateY(-2px); }

        .row-paid { opacity: 0.4; text-decoration: line-through; background-color: rgba(16, 185, 129, 0.03) !important; }
        .row-hover:hover { background-color: #1e293b; }
        input, textarea, select { background-color: #1e293b !important; color: white !important; outline: none !important; border-radius: 8px; }
        input:focus { background-color: #1e293b !important; box-shadow: inset 0 0 0 1px #3b82f6 !important; }
        
        .date-cell { position: relative; width: 100%; height: 100%; display: flex; align-items: center; }
        .date-trigger { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 20; }
        .date-display { pointer-events: none; z-index: 10; position: relative; width: 100%; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-enter { animation: modalEnter 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalEnter { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        #toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 2rem; border-radius: 1rem; background: #1e293b; color: white; border: 1px solid #3b82f6; z-index: 300; display: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }

        /* â”€â”€ CALENDAR COMPACTO â”€â”€ */
        .cal-cell {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 6px;
            background: #0f172a;
            border: 1px solid #1e293b;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 2px;
        }
        .cal-cell:hover { background: #1e293b; border-color: #3b82f6; }
        .cal-cell.cal-today  { border-color: #3b82f6; background: rgba(59,130,246,0.12); }
        .cal-cell.cal-selected { border-color: #3b82f6; background: rgba(59,130,246,0.22); box-shadow: 0 0 0 1px #3b82f6; }
        .cal-cell.cal-empty  { background: transparent; border-color: transparent; cursor: default; pointer-events: none; }
        .cal-day-num { font-size: 11px; font-weight: 900; color: #475569; line-height: 1; }
        .cal-today   .cal-day-num { color: #60a5fa; }
        .cal-selected .cal-day-num { color: #93c5fd; }
        .cal-dot-wrap { display: flex; gap: 2px; justify-content: center; }
        .cal-dot { width: 4px; height: 4px; border-radius: 50%; flex-shrink: 0; }
        .cal-dot.paid    { background: #10b981; }
        .cal-dot.pending { background: #f59e0b; }

        /* â”€â”€ HISTORIAL LATERAL â”€â”€ */
        #hist-list { overflow-y: auto; max-height: 340px; }
        #hist-list::-webkit-scrollbar { width: 4px; }
        #hist-list::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }

        /* â”€â”€ NOTIFICACIONES â”€â”€ */
        #notif-drawer {
            position: fixed; top: 0; right: 0; height: 100vh; width: 380px; max-width: 95vw;
            background: #0a0f1e; border-left: 1px solid #1e293b;
            z-index: 400; transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16,1,0.3,1);
            display: flex; flex-direction: column;
            box-shadow: -20px 0 60px rgba(0,0,0,0.6);
        }
        #notif-drawer.open { transform: translateX(0); }
        #notif-overlay {
            position: fixed; inset: 0; z-index: 399;
            background: rgba(2,6,23,0.7); backdrop-filter: blur(4px);
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        #notif-overlay.open { display: block; opacity: 1; }
        #notif-list { overflow-y: auto; flex: 1; }
        #notif-list::-webkit-scrollbar { width: 4px; }
        #notif-list::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
        .notif-dot {
            width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
            box-shadow: 0 0 6px currentColor;
        }
        #notif-bell-badge {
            position: absolute; top: -4px; right: -4px;
            background: #ef4444; color: white; font-size: 9px; font-weight: 900;
            min-width: 16px; height: 16px; border-radius: 99px; padding: 0 3px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #020617; line-height: 1;
        }
    </style>
</head>
<body class="min-h-screen font-sans bg-slate-950 text-slate-200">

<div id="toast"></div>

<div id="app-root">
    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-[200] bg-slate-950 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-10 rounded-[3rem] shadow-2xl border-blue-500/20 text-center space-y-8 fade-in">
            <div class="space-y-2">
                <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto flex items-center justify-center shadow-2xl rotate-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                </div>
                <h2 class="text-3xl font-black tracking-tighter mt-4 uppercase italic">Finance <span class="text-blue-500">Master</span></h2>
                <p id="login-instruction" class="text-slate-500 text-xs font-bold uppercase tracking-widest">Panel de Control Financiero</p>
            </div>

            <div class="space-y-4">
                <div class="text-left">
                    <label class="text-[10px] font-black text-slate-500 uppercase ml-4 mb-1 block">Usuario</label>
                    <input type="text" id="login-user" placeholder="Nombre de usuario" class="w-full p-4 bg-slate-800 rounded-2xl font-bold border border-slate-700 focus:border-blue-500 transition-colors placeholder-slate-600" onkeydown="if(event.key==='Enter') handleAccess('login')">
                </div>
                <div class="text-left">
                    <label class="text-[10px] font-black text-slate-500 uppercase ml-4 mb-1 block">ContraseÃ±a</label>
                    <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-4 bg-slate-800 rounded-2xl font-bold border border-slate-700 focus:border-blue-500 transition-colors placeholder-slate-600" onkeydown="if(event.key==='Enter') handleAccess('login')">
                </div>
                
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="handleAccess('login')" id="login-btn" class="py-4 bg-slate-800 hover:bg-slate-700 text-white font-black rounded-2xl transition-all active:scale-95 border border-slate-700">ENTRAR</button>
                    <button onclick="handleAccess('create')" id="create-btn" class="py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-2xl shadow-xl active:scale-95 transition-all">CREAR PERFIL</button>
                </div>
            </div>
            <p class="text-[9px] text-slate-600 uppercase font-black tracking-widest opacity-50">VersiÃ³n V9.2 Cloud</p>
        </div>
    </div>

    <!-- Dashboard Principal -->
    <div id="dashboard-content" class="hidden">
        <div class="max-w-7xl mx-auto p-4 md:p-8 fade-in">
            <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-10">
                <div>
                    <div class="flex items-center gap-3">
                        <h1 class="text-4xl font-black tracking-tighter italic text-white">AI<span class="text-blue-500">Finance</span></h1>
                        <span class="px-2 py-1 bg-blue-600/20 text-blue-400 border border-blue-500/30 text-[10px] font-bold rounded uppercase tracking-widest text-nowrap">V9.2</span>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <p class="text-slate-400 font-medium italic text-sm">SesiÃ³n activa:</p>
                        <button onclick="toggleProfileOptions(true)" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 px-4 py-1.5 rounded-full border border-slate-700 text-sm text-blue-400 font-bold transition-all group">
                            <span id="current-profile-name">...</span>
                            <span>â–¼</span>
                        </button>
                        <button onclick="logout()" class="text-slate-600 hover:text-red-400 text-xs font-bold uppercase ml-4 transition-colors">Cerrar SesiÃ³n</button>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveCurrentData(true)" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black hover:bg-emerald-700 shadow-lg flex items-center gap-2 active:scale-95 transition-all">
                        <span>ðŸ’¾</span> <span id="save-txt">Guardar Todo</span>
                    </button>
                    <button onclick="addNewTab()" class="bg-slate-800 text-slate-200 border border-slate-700 px-6 py-3 rounded-2xl font-black hover:bg-slate-700 transition-all">
                        + PestaÃ±a
                    </button>
                    <!-- BotÃ³n Notificaciones -->
                    <button onclick="openNotifDrawer()" class="relative bg-slate-800 border border-slate-700 px-4 py-3 rounded-2xl hover:bg-slate-700 transition-all active:scale-95" title="Pagos pendientes prÃ³ximos">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                        <span id="notif-bell-badge" class="hidden">0</span>
                    </button>
                </div>
            </header>

            <nav id="tab-container" class="flex overflow-x-auto gap-2 border-b border-slate-800 mb-8 bg-slate-900/50 p-2 rounded-2xl min-h-[60px] items-center"></nav>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 space-y-6">
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="dark-card p-6 rounded-3xl relative overflow-hidden group shadow-xl transition-all">
                            <div class="absolute -right-2 -top-2 opacity-10 text-slate-400 group-hover:scale-110 transition-transform duration-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                            </div>
                            <p class="text-slate-500 text-[10px] font-black uppercase mb-1 tracking-widest relative z-10">Total Acumulado</p>
                            <p id="sum-total" class="text-2xl font-black text-white relative z-10 font-mono">$0.00</p>
                        </div>
                        <div class="dark-card p-6 rounded-3xl relative overflow-hidden group shadow-xl border-emerald-900/20">
                            <div class="absolute -right-2 -top-2 opacity-20 text-emerald-500 group-hover:scale-110 transition-transform duration-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <p class="text-emerald-400 text-[10px] font-black uppercase mb-1 tracking-widest relative z-10">Total Pagado</p>
                            <p id="sum-paid" class="text-2xl font-black text-emerald-400 relative z-10 font-mono">$0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-700 to-indigo-900 p-6 rounded-3xl relative overflow-hidden group shadow-xl border border-blue-500/30 transition-all">
                            <div class="absolute -right-2 -top-2 opacity-30 text-white group-hover:scale-110 transition-transform duration-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <p class="text-blue-200 text-[10px] font-black uppercase mb-1 tracking-widest relative z-10">Pendiente Real</p>
                            <p id="sum-pending" class="text-3xl font-black text-white relative z-10 font-mono">$0.00</p>
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="dark-card rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-800">
                        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/30 gap-4">
                            <div class="flex items-center gap-3">
                                <h2 id="current-tab-title" class="text-xl font-black uppercase italic tracking-tighter transition-all">Cargando...</h2>
                                <span id="tab-count" class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 font-mono border border-slate-700">0 items</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="searchInput" oninput="renderTable()" placeholder="Buscar..." class="px-3 py-1.5 rounded-lg border border-slate-700 text-sm bg-slate-800 w-32 focus:w-48 transition-all text-white focus:border-blue-500 outline-none">
                                <button onclick="addRow()" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-blue-500 active:scale-95 transition-all shadow-lg">+ AÃ±adir</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto h-[500px] custom-scrollbar">
                            <table class="w-full text-left">
                                <thead class="bg-slate-900/80 text-slate-500 text-[10px] font-black uppercase sticky top-0 z-20 backdrop-blur-md">
                                    <tr>
                                        <th class="px-6 py-4 w-16 text-center border-b border-slate-800">Ok</th>
                                        <th class="px-6 py-4 border-b border-slate-800">Concepto</th>
                                        <th class="px-6 py-4 w-40 border-b border-slate-800 text-center">Fecha</th>
                                        <th class="px-6 py-4 w-32 border-b border-slate-800">Monto ($)</th>
                                        <th class="px-6 py-4 w-12 border-b border-slate-800"></th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body" class="divide-y divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <aside class="lg:col-span-4 flex flex-col gap-6">
                    <div class="dark-card p-8 rounded-[2.5rem] shadow-xl">
                        <h3 class="font-black text-slate-400 text-xs uppercase tracking-widest mb-6">ðŸ“Š ConcentraciÃ³n</h3>
                        <div class="h-56 relative"><canvas id="pieChart"></canvas></div>
                    </div>

                    <!-- â”€â”€ AGENTE IA â”€â”€ -->
                    <div class="dark-card rounded-[2.5rem] shadow-xl border border-purple-500/20 flex flex-col" style="min-height:0; flex:1;">
                        <!-- Header -->
                        <div class="flex items-center justify-between px-6 pt-6 pb-4 border-b border-slate-800 flex-shrink-0">
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 rounded-xl bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-1H1a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>
                                </div>
                                <h3 class="font-black text-sm uppercase italic tracking-widest text-purple-400">Asesor IA</h3>
                            </div>
                            <button onclick="runAIAnalysis()" id="ai-run-btn"
                                class="flex items-center gap-1.5 text-[10px] font-black bg-purple-600/15 text-purple-400 border border-purple-500/30 px-3 py-1.5 rounded-xl hover:bg-purple-600 hover:text-white hover:border-purple-600 transition-all active:scale-95">
                                <svg id="ai-btn-icon" xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                <span id="ai-btn-label">ANALIZAR</span>
                            </button>
                        </div>

                        <!-- Cuerpo: respuesta del agente -->
                        <div id="ai-body" class="flex-1 overflow-y-auto px-6 py-5 text-sm text-slate-300 leading-relaxed" style="max-height:360px; min-height:120px;">
                            <div id="ai-placeholder" class="flex flex-col items-center justify-center h-full gap-3 text-slate-600 py-6">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="opacity-40"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-1H1a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>
                                <p class="text-xs font-bold italic text-center">Presiona Analizar para que el asesor<br>revise tus finanzas</p>
                            </div>
                            <div id="ai-response" class="hidden space-y-3"></div>
                            <div id="ai-loading" class="hidden flex flex-col items-center justify-center gap-3 py-8">
                                <div class="flex gap-1.5">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay:0ms"></div>
                                    <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay:150ms"></div>
                                    <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay:300ms"></div>
                                </div>
                                <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest">Analizando tus datos...</p>
                            </div>
                        </div>

                        <!-- Input de pregunta libre -->
                        <div class="border-t border-slate-800 px-4 py-3 flex gap-2 flex-shrink-0">
                            <input id="ai-question" type="text" placeholder="Hazle una pregunta al asesor..."
                                class="flex-1 bg-slate-800 text-white text-xs font-medium px-3 py-2 rounded-xl border border-slate-700 focus:border-purple-500 outline-none placeholder-slate-600 transition-colors"
                                onkeydown="if(event.key==='Enter') askAI()">
                            <button onclick="askAI()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded-xl text-xs font-black transition-all active:scale-95 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                            </button>
                        </div>
                    </div>
                </aside>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 HISTORIAL â€” CALENDARIO + LISTA LATERAL
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="dark-card rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-800 mt-8">

                <!-- Cabecera -->
                <div class="p-4 border-b border-slate-800 flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-900/30 gap-3">
                    <div class="flex items-center gap-3">
                        <h2 class="text-lg font-black uppercase italic tracking-tighter">ðŸ—“ Historial</h2>
                        <span id="hist-count" class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 font-mono border border-slate-700">0 items</span>
                        <span id="cal-tab-label" class="text-xs font-black bg-blue-600/20 text-blue-400 border border-blue-500/30 px-3 py-1 rounded-full uppercase tracking-widest"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="calNav(-1)" class="bg-slate-800 border border-slate-700 hover:bg-slate-700 text-white font-black px-3 py-1 rounded-xl text-sm transition-all active:scale-95">â—€</button>
                        <span id="cal-month-label" class="text-xs font-black text-blue-400 min-w-[130px] text-center font-mono bg-slate-800/50 px-3 py-1.5 rounded-xl border border-slate-700"></span>
                        <button onclick="calNav(1)" class="bg-slate-800 border border-slate-700 hover:bg-slate-700 text-white font-black px-3 py-1 rounded-xl text-sm transition-all active:scale-95">â–¶</button>
                        <button onclick="calGoToday()" class="bg-slate-800 border border-slate-700 hover:bg-blue-600 hover:border-blue-500 text-slate-400 hover:text-white font-black px-3 py-1 rounded-xl text-[10px] transition-all uppercase tracking-wide">Hoy</button>
                    </div>
                </div>

                <!-- Resumen del mes -->
                <div class="grid grid-cols-3 border-b border-slate-800">
                    <div class="p-3 text-center border-r border-slate-800">
                        <p class="text-slate-500 text-[9px] font-black uppercase tracking-widest mb-0.5">Total Mes</p>
                        <p id="hist-sum-total" class="text-sm font-black text-white font-mono">$0.00</p>
                    </div>
                    <div class="p-3 text-center border-r border-slate-800">
                        <p class="text-emerald-400 text-[9px] font-black uppercase tracking-widest mb-0.5">Pagado</p>
                        <p id="hist-sum-paid" class="text-sm font-black text-emerald-400 font-mono">$0.00</p>
                    </div>
                    <div class="p-3 text-center">
                        <p class="text-blue-200 text-[9px] font-black uppercase tracking-widest mb-0.5">Pendiente</p>
                        <p id="hist-sum-pending" class="text-sm font-black text-blue-400 font-mono">$0.00</p>
                    </div>
                </div>

                <!-- Cuerpo: Calendario izquierda + Lista derecha -->
                <div class="flex flex-col lg:flex-row">

                    <!-- â”€â”€ CALENDARIO â”€â”€ -->
                    <div class="p-5 border-b lg:border-b-0 lg:border-r border-slate-800" style="flex:0 0 auto; width:100%; max-width:340px;">
                        <!-- DÃ­as de la semana -->
                        <div class="grid grid-cols-7 mb-1.5">
                            <div class="text-center text-xs font-black text-slate-400 uppercase py-1">D</div>
                            <div class="text-center text-xs font-black text-slate-400 uppercase py-1">L</div>
                            <div class="text-center text-xs font-black text-slate-400 uppercase py-1">M</div>
                            <div class="text-center text-xs font-black text-slate-400 uppercase py-1">X</div>
                            <div class="text-center text-xs font-black text-slate-400 uppercase py-1">J</div>
                            <div class="text-center text-xs font-black text-slate-400 uppercase py-1">V</div>
                            <div class="text-center text-xs font-black text-slate-400 uppercase py-1">S</div>
                        </div>
                        <!-- Grid de dÃ­as -->
                        <div id="cal-grid" class="grid grid-cols-7 gap-1"></div>

                        <!-- Leyenda -->
                        <div class="flex items-center gap-4 mt-3 justify-center">
                            <div class="flex items-center gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
                                <span class="text-[10px] font-bold text-slate-500">Pagado</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div>
                                <span class="text-[10px] font-bold text-slate-500">Pendiente</span>
                            </div>
                        </div>
                    </div>

                    <!-- â”€â”€ LISTA LATERAL DE TRANSACCIONES â”€â”€ -->
                    <div class="flex-1 flex flex-col min-w-0">
                        <!-- TÃ­tulo de la lista -->
                        <div class="px-5 py-3 border-b border-slate-800 flex items-center justify-between bg-slate-900/20">
                            <h3 id="hist-list-title" class="text-xs font-black uppercase italic tracking-widest text-slate-400">Transacciones del mes</h3>
                            <span id="hist-list-count" class="text-[10px] font-mono text-slate-600">0</span>
                        </div>
                        <!-- Lista scrolleable -->
                        <div id="hist-list" class="flex-1 divide-y divide-slate-800/60">
                            <div id="hist-list-empty" class="flex items-center justify-center py-12 text-slate-600 text-xs italic font-bold">Sin transacciones</div>
                        </div>
                    </div>
                </div>

                <!-- Panel detalle del dÃ­a (se expande abajo al hacer click) -->
                <div id="cal-detail" class="hidden border-t border-slate-800">
                    <div class="p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h3 id="cal-detail-title" class="font-black text-sm uppercase italic tracking-tighter text-blue-400"></h3>
                            <button onclick="closeDayDetail()" class="text-slate-600 hover:text-red-400 font-black text-xs transition-colors px-2 uppercase tracking-wide">âœ• cerrar</button>
                        </div>
                        <div id="cal-detail-body" class="space-y-2"></div>
                    </div>
                </div>

            </div>
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         OVERLAY y DRAWER DE NOTIFICACIONES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="notif-overlay" onclick="closeNotifDrawer()"></div>

    <div id="notif-drawer">
        <!-- Header del drawer -->
        <div class="flex items-center justify-between px-6 py-5 border-b border-slate-800 bg-slate-900/60 flex-shrink-0">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                <h2 class="text-base font-black uppercase italic tracking-tighter text-white">Pagos PrÃ³ximos</h2>
                <span id="notif-total-count" class="text-[10px] font-mono bg-slate-800 text-slate-400 border border-slate-700 px-2 py-0.5 rounded">0</span>
            </div>
            <button onclick="closeNotifDrawer()" class="text-slate-600 hover:text-red-400 font-black text-lg transition-colors leading-none">âœ•</button>
        </div>

        <!-- Leyenda de colores -->
        <div class="px-5 py-3 border-b border-slate-800 flex flex-wrap gap-x-4 gap-y-1.5 bg-slate-900/30 flex-shrink-0">
            <div class="flex items-center gap-1.5"><div class="notif-dot" style="background:#ef4444;color:#ef4444"></div><span class="text-[9px] font-black text-slate-500 uppercase tracking-wide">Hoy</span></div>
            <div class="flex items-center gap-1.5"><div class="notif-dot" style="background:#f87171;color:#f87171"></div><span class="text-[9px] font-black text-slate-500 uppercase tracking-wide">2-3 dÃ­as</span></div>
            <div class="flex items-center gap-1.5"><div class="notif-dot" style="background:#fb923c;color:#fb923c"></div><span class="text-[9px] font-black text-slate-500 uppercase tracking-wide">1 semana</span></div>
            <div class="flex items-center gap-1.5"><div class="notif-dot" style="background:#fbbf24;color:#fbbf24"></div><span class="text-[9px] font-black text-slate-500 uppercase tracking-wide">2 semanas</span></div>
            <div class="flex items-center gap-1.5"><div class="notif-dot" style="background:#34d399;color:#34d399"></div><span class="text-[9px] font-black text-slate-500 uppercase tracking-wide">3 semanas</span></div>
            <div class="flex items-center gap-1.5"><div class="notif-dot" style="background:#60a5fa;color:#60a5fa"></div><span class="text-[9px] font-black text-slate-500 uppercase tracking-wide">1 mes</span></div>
            <div class="flex items-center gap-1.5"><div class="notif-dot" style="background:#a78bfa;color:#a78bfa"></div><span class="text-[9px] font-black text-slate-500 uppercase tracking-wide">2+ meses</span></div>
        </div>

        <!-- Lista de notificaciones -->
        <div id="notif-list" class="divide-y divide-slate-800/60">
            <div id="notif-empty" class="flex flex-col items-center justify-center py-16 gap-3 text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="opacity-30"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                <p class="text-xs italic font-bold">Sin pagos futuros pendientes</p>
            </div>
        </div>
    </div>

    <!-- Modal Editar Perfil -->
    <div id="edit-profile-modal" class="fixed inset-0 z-[250] bg-slate-950/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-[2rem] shadow-2xl modal-enter">
            <div class="p-8 space-y-6 text-center">
                <h3 class="text-xl font-bold text-white uppercase italic">Editar Perfil</h3>
                <div class="space-y-4">
                    <input type="text" id="edit-profile-name" class="w-full p-4 bg-slate-800 rounded-xl font-bold border border-slate-700 text-white outline-none focus:border-blue-500">
                    <div class="flex gap-2">
                        <button onclick="toggleProfileOptions(false)" class="flex-1 py-3 text-slate-500 font-bold uppercase text-xs hover:text-white">Cancelar</button>
                        <button onclick="renameCurrentProfile()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl active:scale-95 transition-all hover:bg-blue-500">Guardar</button>
                    </div>
                    <button onclick="deleteCurrentProfile()" class="w-full py-3 bg-red-600/10 text-red-500 font-bold rounded-xl text-xs hover:bg-red-600 hover:text-white transition-all">ELIMINAR PERFIL</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPT 1: mÃ³dulo Firebase â€” solo expone _fb al window -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let firebaseConfig = {};
    try { firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'); } catch(e) {}
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'finance-master-v9';

    let firebaseReady = false, auth, db;
    try {
        if (firebaseConfig && firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            firebaseReady = true;
        }
    } catch(e) { console.warn('Firebase no disponible, modo offline activado.'); }

    window._fb = { firebaseReady, auth, db, appId, signInAnonymously, doc, setDoc, getDoc, deleteDoc };
    window._fbReady = true;
    document.dispatchEvent(new Event('fb-ready'));
</script>

<!-- SCRIPT 2: lÃ³gica de la app â€” SIN type="module", scope global puro -->
<script>
// â”€â”€â”€ DATOS MAESTROS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var MASTER_RECORDS = {
    "Deuda Ana": [
        { c: "Gorra y reloj Angelito", f: "2025-12-03", m: 140, p: false },
        { c: "Arreglo del carro", f: "2025-12-15", m: 600, p: false },
        { c: "Ropa y medias Walmart Vegas", f: "2025-12-31", m: 30, p: false },
        { c: "Hotel Arizona", f: "2025-12-31", m: 78, p: false },
        { c: "Gasolina", f: "", m: 27, p: false },
        { c: "Walmart Midland", f: "", m: 70, p: false },
        { c: "Ropa de trabajo con Yovani", f: "", m: 95, p: false },
        { c: "Silla Gamer", f: "", m: 60, p: false },
        { c: "SAMS Compras Tormenta frio", f: "", m: 89, p: false },
        { c: "Tienda cubana de la seÃ±ora", f: "", m: 84, p: false },
        { c: "Aseguranza", f: "2026-01-27", m: 97.16, p: false },
        { c: "Cigarro", f: "", m: 35, p: false },
        { c: "EHB y Tiendita (Pizza y Batido)", f: "", m: 40, p: false },
        { c: "Vape", f: "", m: 37, p: false },
        { c: "Pizza y frituras Miami Market", f: "", m: 30, p: false },
        { c: "Bombillos frenos carro", f: "", m: 10, p: false },
        { c: "Pizzas Y Refresco Batalla Beatriz", f: "2026-02-12", m: 60, p: false },
        { c: "Restaurante con los niÃ±os", f: "2026-02-14", m: 110, p: false },
        { c: "Walmart, Ropa trabajo, Vape, etc", f: "2026-02-15", m: 263, p: false },
        { c: "Maletero del carro", f: "", m: 155, p: false }
    ],
    "Bills": [
        { c: "TelÃ©fono y Linea", f: "2026-02-21", m: 113.17, p: false },
        { c: "Internet Att", f: "2026-02-20", m: 65, p: false },
        { c: "Renta", f: "2026-03-01", m: 700, p: false },
        { c: "Cuaracao", f: "2026-02-09", m: 33, p: true }
    ],
    "Deuda Con Cristy": [{ c: "Renta", f: "2026-02-01", m: 400, p: false }],
    "Pagos de Tarjetas": [
        { c: "Credit One", f: "", m: 60.14, p: false },
        { c: "American Express", f: "2026-03-24", m: 375, p: false }
    ],
    "Ingresos": [],
    "Gastos": []
};

// â”€â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var currentUser = null;
var localData = { db: {}, goals: [] };
var activeTab = "";
var pieChart = null;

// â”€â”€â”€ HELPER: esperar a que el mÃ³dulo Firebase termine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _waitForFB(cb) {
    if (window._fbReady) { cb(); }
    else { document.addEventListener('fb-ready', cb, { once: true }); }
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDate(d) {
    if (!d) return "ðŸ“… -/-";
    try { var dt = new Date(d + 'T12:00:00'); return "ðŸ“… " + dt.getDate() + "/" + (dt.getMonth()+1); }
    catch(e) { return "ðŸ“… -/-"; }
}

function showToast(msg, color) {
    var t = document.getElementById('toast');
    t.innerText = msg;
    t.style.borderColor = color === 'red' ? '#ef4444' : '#3b82f6';
    t.style.display = 'block';
    clearTimeout(t._tid);
    t._tid = setTimeout(function() { t.style.display = 'none'; }, 2500);
}

function escVal(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ ACCESO / LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleAccess(mode) {
    _waitForFB(function() {
        var user = document.getElementById('login-user').value.trim();
        var pass = document.getElementById('login-pass').value.trim();
        if (!user || !pass) return showToast("Faltan datos", "red");

        var btn = mode === 'login' ? document.getElementById('login-btn') : document.getElementById('create-btn');
        var orig = btn.innerText;
        btn.innerText = "Procesando...";
        btn.disabled = true;

        var fb = window._fb || {};

        var finish = function() { btn.innerText = orig; btn.disabled = false; };

        if (!fb.firebaseReady) {
            // Modo offline / localStorage
            var key = 'fm_profile_' + user;
            var stored = localStorage.getItem(key);
            if (mode === 'login') {
                if (!stored) { showToast("Usuario no encontrado", "red"); finish(); return; }
                if (JSON.parse(stored).password !== pass) { showToast("ContraseÃ±a incorrecta", "red"); finish(); return; }
                currentUser = { id: user, name: user };
                var d = localStorage.getItem('fm_data_' + user);
                localData = d ? JSON.parse(d) : { db: { "General": [] }, goals: [] };
            } else {
                if (stored) { showToast("El usuario ya existe", "red"); finish(); return; }
                localStorage.setItem(key, JSON.stringify({ password: pass }));
                currentUser = { id: user, name: user };
                var isLuisi = (user === 'Luisi' && pass === 'Angelluis12');
                localData = { db: isLuisi ? JSON.parse(JSON.stringify(MASTER_RECORDS)) : { "General": [] }, goals: [] };
                localStorage.setItem('fm_data_' + user, JSON.stringify(localData));
            }
            finish();
            enterDashboard();
            return;
        }

        // Modo Firebase (async)
        fb.signInAnonymously(fb.auth).then(function() {
            var profileRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_profiles_' + user);
            return fb.getDoc(profileRef).then(function(snap) {
                if (mode === 'login') {
                    if (!snap.exists()) { showToast("Usuario no encontrado", "red"); return; }
                    if (snap.data().password !== pass) { showToast("ContraseÃ±a incorrecta", "red"); return; }
                    currentUser = { id: user, name: user };
                    var dataRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_data_' + user);
                    return fb.getDoc(dataRef).then(function(dSnap) {
                        localData = dSnap.exists() ? dSnap.data() : { db: { "General": [] }, goals: [] };
                        enterDashboard();
                    });
                } else {
                    if (snap.exists()) { showToast("El usuario ya existe", "red"); return; }
                    return fb.setDoc(profileRef, { password: pass, name: user }).then(function() {
                        currentUser = { id: user, name: user };
                        var isLuisi = (user === 'Luisi' && pass === 'Angelluis12');
                        localData = { db: isLuisi ? JSON.parse(JSON.stringify(MASTER_RECORDS)) : { "General": [] }, goals: [] };
                        var dataRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_data_' + user);
                        return fb.setDoc(dataRef, localData).then(function() { enterDashboard(); });
                    });
                }
            });
        }).catch(function(e) {
            console.error(e);
            showToast("Error de conexiÃ³n. Intenta de nuevo.", "red");
        }).finally(function() { finish(); });
    });
}

function enterDashboard() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('dashboard-content').classList.remove('hidden');
    document.getElementById('current-profile-name').innerText = currentUser.name;
    if (!localData.goals) localData.goals = [];
    if (!localData.db) localData.db = {};
    activeTab = Object.keys(localData.db)[0] || "";
    refreshUI();
}

function logout() { location.reload(); }

// â”€â”€â”€ UI REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshUI() {
    renderTabs();
    renderTable();
    renderCharts();
    renderCalendar();
    renderNotifDrawer();
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabs() {
    var container = document.getElementById('tab-container');
    container.innerHTML = "";
    Object.keys(localData.db).forEach(function(tab) {
        var div = document.createElement('div');
        var isActive = activeTab === tab;
        div.className = 'tab-item px-6 py-3 font-black text-sm whitespace-nowrap border-b-2 ' +
            (isActive ? 'tab-active' : 'text-slate-500 border-transparent hover:text-slate-300');
        var labelSpan = document.createElement('span');
        labelSpan.textContent = tab;
        labelSpan.style.cursor = 'pointer';
        labelSpan.addEventListener('click', function() { setActiveTab(tab); });
        var delBtn = document.createElement('button');
        delBtn.textContent = 'âœ•';
        delBtn.className = 'ml-2 opacity-20 hover:opacity-100 transition-all font-bold';
        delBtn.addEventListener('click', function(e) { e.stopPropagation(); deleteTab(tab); });
        div.appendChild(labelSpan);
        div.appendChild(delBtn);
        container.appendChild(div);
    });
}

function setActiveTab(tab) {
    activeTab = tab;
    // Resetear calendario al mes actual cuando se cambia de pestaÃ±a
    var now = new Date();
    calYear   = now.getFullYear();
    calMonth  = now.getMonth();
    calSelDay = null;
    refreshUI();
}

// â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
    var body = document.getElementById('data-table-body');
    var search = (document.getElementById('searchInput').value || '').toLowerCase();
    document.getElementById('current-tab-title').innerText = activeTab;
    body.innerHTML = "";

    var items = localData.db[activeTab] || [];
    document.getElementById('tab-count').innerText = items.length + ' items';

    items.forEach(function(item, i) {
        if (search && !item.c.toLowerCase().includes(search)) return;

        var tr = document.createElement('tr');
        tr.className = 'transition-all duration-300 border-b border-slate-800 last:border-0 ' + (item.p ? 'row-paid' : 'row-hover');

        // OK checkbox
        var tdChk = document.createElement('td');
        tdChk.className = 'px-6 py-4 text-center';
        var chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.checked = !!item.p;
        chk.className = 'w-5 h-5 accent-emerald-500 cursor-pointer rounded';
        (function(idx) { chk.addEventListener('change', function() { togglePaid(idx); }); })(i);
        tdChk.appendChild(chk);

        // Concepto
        var tdC = document.createElement('td');
        tdC.className = 'px-6 py-4 font-bold text-sm';
        var inpC = document.createElement('input');
        inpC.type = 'text';
        inpC.value = item.c;
        inpC.className = 'bg-transparent w-full outline-none';
        inpC.placeholder = '...';
        (function(idx) { inpC.addEventListener('input', function() { updateItem(idx, 'c', this.value); }); })(i);
        tdC.appendChild(inpC);

        // Fecha
        var tdF = document.createElement('td');
        tdF.className = 'px-6 py-4 text-xs font-mono text-center';
        var dateWrap = document.createElement('div');
        dateWrap.className = 'date-cell group';
        var dateSpan = document.createElement('span');
        dateSpan.className = 'date-display text-slate-500 font-bold';
        dateSpan.textContent = formatDate(item.f);
        var datePicker = document.createElement('input');
        datePicker.type = 'date';
        datePicker.className = 'date-trigger';
        datePicker.value = item.f || '';
        (function(idx) {
            datePicker.addEventListener('change', function() { updateItem(idx, 'f', this.value); renderTable(); });
            datePicker.addEventListener('click', function() { if (this.showPicker) this.showPicker(); });
        })(i);
        dateWrap.appendChild(dateSpan);
        dateWrap.appendChild(datePicker);
        tdF.appendChild(dateWrap);

        // Monto
        var tdM = document.createElement('td');
        tdM.className = 'px-6 py-4 font-black text-blue-400 font-mono';
        var mWrap = document.createElement('div');
        mWrap.className = 'flex items-center gap-1 font-mono font-bold';
        var dollar = document.createElement('span');
        dollar.textContent = '$';
        var inpM = document.createElement('input');
        inpM.type = 'number';
        inpM.step = '0.01';
        inpM.value = item.m;
        inpM.className = 'bg-transparent w-full outline-none';
        (function(idx) { inpM.addEventListener('input', function() { updateItem(idx, 'm', this.value); }); })(i);
        mWrap.appendChild(dollar);
        mWrap.appendChild(inpM);
        tdM.appendChild(mWrap);

        // Delete
        var tdDel = document.createElement('td');
        tdDel.className = 'px-6 py-4 text-center';
        var delBtn = document.createElement('button');
        delBtn.className = 'text-slate-700 hover:text-red-500 p-2 transition-all';
        delBtn.textContent = 'âœ•';
        (function(idx) { delBtn.addEventListener('click', function() { removeRow(idx); }); })(i);
        tdDel.appendChild(delBtn);

        tr.appendChild(tdChk);
        tr.appendChild(tdC);
        tr.appendChild(tdF);
        tr.appendChild(tdM);
        tr.appendChild(tdDel);
        body.appendChild(tr);
    });

    updateTotals();
}

function updateTotals() {
    var total = 0, paid = 0;
    (localData.db[activeTab] || []).forEach(function(item) {
        var v = parseFloat(item.m || 0); total += v; if (item.p) paid += v;
    });
    document.getElementById('sum-total').innerText = '$' + total.toLocaleString('en-US', {minimumFractionDigits:2});
    document.getElementById('sum-paid').innerText = '$' + paid.toLocaleString('en-US', {minimumFractionDigits:2});
    document.getElementById('sum-pending').innerText = '$' + (total-paid).toLocaleString('en-US', {minimumFractionDigits:2});
    saveCurrentData();
}

// â”€â”€â”€ ACCIONES DE DATOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateItem(i, k, v) {
    if (!localData.db[activeTab]) return;
    localData.db[activeTab][i][k] = k === 'm' ? parseFloat(v || 0) : v;
    updateTotals(); updateCharts();
}
function togglePaid(i) { localData.db[activeTab][i].p = !localData.db[activeTab][i].p; renderTable(); updateCharts(); }
function addRow() {
    if (!activeTab) return;
    var now = new Date();
    var todayStr = now.getFullYear() + '-' +
        String(now.getMonth()+1).padStart(2,'0') + '-' +
        String(now.getDate()).padStart(2,'0');
    localData.db[activeTab].push({ c: "Nuevo Registro", f: todayStr, m: 0, p: false });
    renderTable();
    renderCalendar();
}
function removeRow(i) { localData.db[activeTab].splice(i, 1); renderTable(); updateCharts(); }
function addNewTab() {
    var n = prompt("Nombre PestaÃ±a:");
    if (n && n.trim()) {
        var name = n.trim();
        if (localData.db[name] !== undefined) return showToast("Ya existe esa pestaÃ±a", "red");
        localData.db[name] = [];
        activeTab = name;
        // Resetear calendario al mes actual
        var now = new Date();
        calYear = now.getFullYear(); calMonth = now.getMonth(); calSelDay = null;
        refreshUI(); saveCurrentData();
    }
}
function deleteTab(tab) {
    if (Object.keys(localData.db).length <= 1) return showToast("No puedes borrar la Ãºltima pestaÃ±a", "red");
    if (confirm('Â¿Borrar "' + tab + '"?')) {
        delete localData.db[tab]; activeTab = Object.keys(localData.db)[0] || ""; refreshUI(); saveCurrentData();
    }
}

function saveCurrentData(feedback) {
    if (!currentUser) return;
    var fb = window._fb || {};
    var doSave = function() {
        if (fb.firebaseReady) {
            var dataRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_data_' + currentUser.id);
            fb.setDoc(dataRef, localData).then(function() {
                if (feedback) showToast("Guardado en la nube", "blue");
            }).catch(function(e) { console.error(e); if (feedback) showToast("Error al guardar", "red"); });
        } else {
            localStorage.setItem('fm_data_' + currentUser.id, JSON.stringify(localData));
            if (feedback) showToast("Guardado localmente", "blue");
        }
    };
    if (window._fbReady) doSave(); else document.addEventListener('fb-ready', doSave, { once: true });
}

// â”€â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts() {
    var ctx = document.getElementById('pieChart').getContext('2d');
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6','#8b5cf6','#10b981','#f59e0b','#ef4444'], borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '82%', plugins: { legend: { display: false } } }
    });
    updateCharts();
}
function updateCharts() {
    if (!pieChart || !localData.db[activeTab]) return;
    var items = localData.db[activeTab];
    pieChart.data.labels = items.map(function(i) { return i.c; });
    pieChart.data.datasets[0].data = items.map(function(i) { return i.m; });
    pieChart.update();
}

// â”€â”€â”€ AGENTE IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Construye un resumen estructurado de los datos financieros para enviarlo a la API
function buildFinancialSummary() {
    var tabs = localData.db || {};
    var lines = [];
    var grandTotal = 0, grandPaid = 0, grandPending = 0;
    var futurePayments = [];
    var today = new Date();
    var todayMs = new Date(today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0') + 'T00:00:00').getTime();

    Object.keys(tabs).forEach(function(tab) {
        var items = tabs[tab] || [];
        var tTotal = 0, tPaid = 0;
        items.forEach(function(item) {
            var v = parseFloat(item.m || 0);
            tTotal += v;
            if (item.p) tPaid += v;
            if (!item.p && item.f) {
                var dMs = new Date(item.f + 'T00:00:00').getTime();
                var diff = Math.round((dMs - todayMs) / 86400000);
                if (diff >= 0) futurePayments.push({ name: item.c, tab: tab, amount: v, daysLeft: diff, date: item.f });
            }
        });
        grandTotal   += tTotal;
        grandPaid    += tPaid;
        grandPending += (tTotal - tPaid);
        lines.push('PestaÃ±a "' + tab + '": ' + items.length + ' registros | Total: $' + tTotal.toFixed(2) + ' | Pagado: $' + tPaid.toFixed(2) + ' | Pendiente: $' + (tTotal - tPaid).toFixed(2));
    });

    futurePayments.sort(function(a, b) { return a.daysLeft - b.daysLeft; });
    var futureLines = futurePayments.slice(0, 10).map(function(p) {
        return '  - ' + p.name + ' (' + p.tab + '): $' + p.amount.toFixed(2) + ' â€” ' + (p.daysLeft === 0 ? 'HOY' : 'en ' + p.daysLeft + ' dÃ­as') + ' (' + p.date + ')';
    });

    return [
        'RESUMEN FINANCIERO ACTUAL:',
        'Total acumulado (todas las pestaÃ±as): $' + grandTotal.toFixed(2),
        'Total pagado: $' + grandPaid.toFixed(2),
        'Total pendiente: $' + grandPending.toFixed(2),
        '',
        'DESGLOSE POR CATEGORÃA:',
        lines.join('\n'),
        '',
        'PRÃ“XIMOS PAGOS PENDIENTES (los mÃ¡s urgentes):',
        futureLines.length > 0 ? futureLines.join('\n') : '  (Ninguno con fecha futura asignada)',
    ].join('\n');
}

function setAILoading(on) {
    document.getElementById('ai-placeholder').classList.add('hidden');
    document.getElementById('ai-response').classList.add('hidden');
    document.getElementById('ai-loading').classList[on ? 'remove' : 'add']('hidden');
    var btn   = document.getElementById('ai-run-btn');
    var icon  = document.getElementById('ai-btn-icon');
    var label = document.getElementById('ai-btn-label');
    btn.disabled = on;
    if (on) {
        label.textContent = 'ANALIZANDO';
        icon.style.opacity = '0.4';
    } else {
        label.textContent = 'ANALIZAR';
        icon.style.opacity = '1';
    }
}

function renderAIResponse(text) {
    setAILoading(false);
    var respEl = document.getElementById('ai-response');
    respEl.innerHTML = '';
    respEl.classList.remove('hidden');
    document.getElementById('ai-loading').classList.add('hidden');
    document.getElementById('ai-placeholder').classList.add('hidden');

    // Parsear el texto â€” detectar lÃ­neas que empiezan con â€¢ ** o nÃºmeros
    var lines = text.split('\n');
    var buffer = [];

    function flushBuffer() {
        if (buffer.length === 0) return;
        var p = document.createElement('p');
        p.className = 'text-slate-300 text-xs leading-relaxed';
        p.textContent = buffer.join(' ');
        respEl.appendChild(p);
        buffer = [];
    }

    lines.forEach(function(line) {
        line = line.trim();
        if (!line) { flushBuffer(); return; }

        // TÃ­tulos con **texto** o toda la lÃ­nea en mayÃºscula con :
        if (/^\*\*.*\*\*/.test(line) || (/^[A-ZÃÃ‰ÃÃ“ÃšÃ‘\s]+:$/.test(line) && line.length < 50)) {
            flushBuffer();
            var h = document.createElement('p');
            h.className = 'text-[10px] font-black uppercase tracking-widest text-purple-400 mt-3 mb-1';
            h.textContent = line.replace(/\*\*/g, '');
            respEl.appendChild(h);
            return;
        }

        // Bullet points
        if (/^[â€¢\-\*]\s/.test(line) || /^\d+\.\s/.test(line)) {
            flushBuffer();
            var bWrap = document.createElement('div');
            bWrap.className = 'flex gap-2 items-start';
            var dot2 = document.createElement('div');
            dot2.className = 'w-1.5 h-1.5 rounded-full bg-purple-500 mt-1.5 flex-shrink-0';
            var bText = document.createElement('p');
            bText.className = 'text-xs text-slate-300 leading-relaxed flex-1';
            bText.textContent = line.replace(/^[â€¢\-\*\d\.]\s+/, '').replace(/\*\*/g, '');
            bWrap.appendChild(dot2);
            bWrap.appendChild(bText);
            respEl.appendChild(bWrap);
            return;
        }

        buffer.push(line.replace(/\*\*/g, ''));
    });
    flushBuffer();
}

var GEMINI_KEY = 'AIzaSyB85u5nmGE4n8bLoBlNWdk_LuBpnyA_6G4';

function callGeminiAPI(prompt, systemPrompt) {
    var url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + GEMINI_KEY;
    return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            system_instruction: { parts: [{ text: systemPrompt }] },
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { maxOutputTokens: 1024, temperature: 0.7 }
        })
    }).then(function(r) { return r.json(); }).then(function(d) {
        if (d.candidates && d.candidates[0] && d.candidates[0].content && d.candidates[0].content.parts[0]) {
            return d.candidates[0].content.parts[0].text;
        }
        if (d.error) throw new Error(d.error.message);
        throw new Error('Sin respuesta de Gemini');
    });
}

function runAIAnalysis() {
    setAILoading(true);
    var summary = buildFinancialSummary();
    var system = 'Eres un asesor financiero personal. Analizas los datos financieros del usuario y das consejos claros, directos y accionables en espaÃ±ol. SÃ© conciso pero Ãºtil. Usa bullets para los consejos. No uses frases genÃ©ricas. Basa TODO en los nÃºmeros reales del usuario.';
    var prompt = summary + '\n\nAnaliza esta situaciÃ³n financiera y dame:\n1. Un diagnÃ³stico rÃ¡pido (2-3 lÃ­neas)\n2. Los 3-5 consejos mÃ¡s importantes y accionables para mejorar mi economÃ­a\n3. Una alerta sobre el pago mÃ¡s urgente si aplica';

    callGeminiAPI(prompt, system)
        .then(function(text) { renderAIResponse(text); })
        .catch(function(e) {
            setAILoading(false);
            renderAIResponse('No se pudo conectar con Gemini. Verifica tu conexiÃ³n e intenta de nuevo.\n\n' + (e.message || ''));
        });
}

function askAI() {
    var q = document.getElementById('ai-question').value.trim();
    if (!q) return;
    document.getElementById('ai-question').value = '';
    setAILoading(true);
    var summary = buildFinancialSummary();
    var system = 'Eres un asesor financiero personal. El usuario te hace preguntas sobre sus finanzas. Responde en espaÃ±ol, de forma directa y prÃ¡ctica. Basa tus respuestas en los datos reales del usuario.';
    var prompt = 'Mis datos financieros actuales:\n\n' + summary + '\n\nMi pregunta: ' + q;

    callGeminiAPI(prompt, system)
        .then(function(text) { renderAIResponse(text); })
        .catch(function(e) {
            setAILoading(false);
            renderAIResponse('Error al conectar con Gemini. Intenta de nuevo.\n\n' + (e.message || ''));
        });
}

// â”€â”€â”€ GESTIÃ“N DE PERFIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleProfileOptions(show) {
    var modal = document.getElementById('edit-profile-modal');
    if (show) { document.getElementById('edit-profile-name').value = currentUser.name; modal.classList.remove('hidden'); }
    else { modal.classList.add('hidden'); }
}

function renameCurrentProfile() {
    var newName = document.getElementById('edit-profile-name').value.trim();
    if (!newName || newName === currentUser.name) return;
    var fb = window._fb || {};
    if (fb.firebaseReady) {
        var oldProfileRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_profiles_' + currentUser.id);
        var newProfileRef = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_profiles_' + newName);
        var oldDataRef    = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_data_' + currentUser.id);
        var newDataRef    = fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_data_' + newName);
        fb.getDoc(newProfileRef).then(function(snap) {
            if (snap.exists()) { showToast("El nombre ya existe", "red"); return; }
            return fb.getDoc(oldProfileRef).then(function(oldSnap) {
                return fb.setDoc(newProfileRef, oldSnap.data())
                    .then(function() { return fb.setDoc(newDataRef, localData); })
                    .then(function() { return fb.deleteDoc(oldProfileRef); })
                    .then(function() { return fb.deleteDoc(oldDataRef); })
                    .then(function() { alert("Perfil renombrado con Ã©xito. Reiniciando sesiÃ³n..."); location.reload(); });
            });
        }).catch(function(e) { console.error(e); showToast("Error al renombrar", "red"); });
    } else {
        var oldKey = 'fm_profile_' + currentUser.id;
        var newKey = 'fm_profile_' + newName;
        if (localStorage.getItem(newKey)) { showToast("El nombre ya existe", "red"); return; }
        localStorage.setItem(newKey, localStorage.getItem(oldKey));
        localStorage.setItem('fm_data_' + newName, JSON.stringify(localData));
        localStorage.removeItem(oldKey);
        localStorage.removeItem('fm_data_' + currentUser.id);
        alert("Perfil renombrado. Reiniciando..."); location.reload();
    }
}

function deleteCurrentProfile() {
    if (!confirm("âš ï¸ Â¿BORRAR PERMANENTEMENTE este perfil y TODOS sus datos? Esta acciÃ³n no se puede deshacer.")) return;
    var fb = window._fb || {};
    if (fb.firebaseReady) {
        fb.deleteDoc(fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_profiles_' + currentUser.id))
            .then(function() { return fb.deleteDoc(fb.doc(fb.db, 'artifacts', fb.appId, 'public', 'data', 'finance_data_' + currentUser.id)); })
            .then(function() { alert("Perfil eliminado."); location.reload(); })
            .catch(function() { showToast("Error al borrar", "red"); });
    } else {
        localStorage.removeItem('fm_profile_' + currentUser.id);
        localStorage.removeItem('fm_data_' + currentUser.id);
        alert("Perfil eliminado."); location.reload();
    }
}

// â”€â”€â”€ HISTORIAL CALENDARIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var calYear   = new Date().getFullYear();
var calMonth  = new Date().getMonth();
var calSelDay = null;

var MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio',
             'Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
var DIAS  = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];

function calNav(dir) {
    calMonth += dir;
    if (calMonth > 11) { calMonth = 0; calYear++; }
    if (calMonth < 0)  { calMonth = 11; calYear--; }
    calSelDay = null;
    document.getElementById('cal-detail').classList.add('hidden');
    renderCalendar();
}

function calGoToday() {
    var now = new Date();
    calYear = now.getFullYear(); calMonth = now.getMonth();
    calSelDay = null;
    document.getElementById('cal-detail').classList.add('hidden');
    renderCalendar();
}

function getItemsByDate() {
    var map = {};
    var selTab = (document.getElementById('hist-tab-select') || {}).value || '__ALL__';
    if (!localData || !localData.db) return map;
    Object.keys(localData.db).forEach(function(tab) {
        if (selTab !== '__ALL__' && tab !== selTab) return;
        (localData.db[tab] || []).forEach(function(item) {
            if (!item.f) return;
            if (!map[item.f]) map[item.f] = [];
            map[item.f].push({ tab: tab, item: item });
        });
    });
    return map;
}

function renderCalendar() {
    if (!document.getElementById('cal-grid')) return;

    // Actualizar select pestaÃ±as
    var sel = document.getElementById('hist-tab-select');
    var prevVal = sel ? sel.value : '__ALL__';
    if (sel) {
        sel.innerHTML = '<option value="__ALL__">Todas</option>';
        if (localData && localData.db) {
            Object.keys(localData.db).forEach(function(tab) {
                var opt = document.createElement('option');
                opt.value = tab; opt.textContent = tab;
                if (tab === prevVal) opt.selected = true;
                sel.appendChild(opt);
            });
        }
    }

    document.getElementById('cal-month-label').innerText = MESES[calMonth] + ' ' + calYear;

    var byDate = getItemsByDate();
    var todayStr = (function() {
        var t = new Date();
        return t.getFullYear() + '-' + String(t.getMonth()+1).padStart(2,'0') + '-' + String(t.getDate()).padStart(2,'0');
    })();
    var monthPfx = calYear + '-' + String(calMonth+1).padStart(2,'0');

    // Totales del mes
    var total = 0, paid = 0, countMes = 0;
    Object.keys(byDate).forEach(function(ds) {
        if (!ds.startsWith(monthPfx)) return;
        byDate[ds].forEach(function(r) {
            var v = parseFloat(r.item.m || 0); total += v; if (r.item.p) paid += v; countMes++;
        });
    });
    var fmtN = function(n) { return '$' + n.toLocaleString('en-US',{minimumFractionDigits:2}); };
    document.getElementById('hist-sum-total').innerText   = fmtN(total);
    document.getElementById('hist-sum-paid').innerText    = fmtN(paid);
    document.getElementById('hist-sum-pending').innerText = fmtN(total - paid);
    document.getElementById('hist-count').innerText       = countMes + ' items';

    // â”€â”€ GRID CALENDARIO â”€â”€
    var grid = document.getElementById('cal-grid');
    grid.innerHTML = '';
    var firstDay    = new Date(calYear, calMonth, 1).getDay();
    var daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

    for (var e = 0; e < firstDay; e++) {
        var empty = document.createElement('div');
        empty.className = 'cal-cell cal-empty';
        grid.appendChild(empty);
    }

    for (var day = 1; day <= daysInMonth; day++) {
        var ds = calYear + '-' + String(calMonth+1).padStart(2,'0') + '-' + String(day).padStart(2,'0');
        var rows = byDate[ds] || [];

        var cell = document.createElement('div');
        var cls = 'cal-cell';
        if (ds === todayStr)  cls += ' cal-today';
        if (ds === calSelDay) cls += ' cal-selected';
        cell.className = cls;

        var dayNum = document.createElement('div');
        dayNum.className = 'cal-day-num';
        dayNum.textContent = day;
        cell.appendChild(dayNum);

        if (rows.length > 0) {
            var dotWrap = document.createElement('div');
            dotWrap.className = 'cal-dot-wrap';
            var shown = Math.min(rows.length, 3);
            for (var di = 0; di < shown; di++) {
                var dot = document.createElement('div');
                dot.className = 'cal-dot ' + (rows[di].item.p ? 'paid' : 'pending');
                dotWrap.appendChild(dot);
            }
            cell.appendChild(dotWrap);
        }

        (function(dateStr, r) {
            cell.addEventListener('click', function() {
                calSelDay = dateStr;
                renderCalendar();
                showDayDetail(dateStr, r);
            });
        })(ds, rows);

        grid.appendChild(cell);
    }

    // â”€â”€ LISTA LATERAL â”€â”€
    renderHistList(byDate, monthPfx);

    // Redibujar detalle si hay dÃ­a seleccionado
    if (calSelDay && byDate[calSelDay]) {
        showDayDetail(calSelDay, byDate[calSelDay]);
    }
}

function renderHistList(byDate, monthPfx) {
    var listEl    = document.getElementById('hist-list');
    var titleEl   = document.getElementById('hist-list-title');
    var countEl   = document.getElementById('hist-list-count');

    // Si hay dÃ­a seleccionado, mostrar solo ese dÃ­a; si no, todo el mes
    var rows = [];
    if (calSelDay) {
        titleEl.innerText = 'DÃ­a seleccionado';
        rows = (byDate[calSelDay] || []).map(function(r) { return { ds: calSelDay, r: r }; });
    } else {
        titleEl.innerText = 'Transacciones del mes';
        Object.keys(byDate).sort().reverse().forEach(function(ds) {
            if (!ds.startsWith(monthPfx)) return;
            byDate[ds].forEach(function(r) { rows.push({ ds: ds, r: r }); });
        });
    }

    countEl.innerText = rows.length;
    listEl.innerHTML = '';

    if (rows.length === 0) {
        listEl.innerHTML = '<div class="flex items-center justify-center py-10 text-slate-600 text-xs italic font-bold">Sin transacciones</div>';
        return;
    }

    rows.forEach(function(entry) {
        var ds   = entry.ds;
        var r    = entry.r;
        var item = r.item;

        var dt   = new Date(ds + 'T12:00:00');
        var row  = document.createElement('div');
        row.className = 'flex items-center gap-3 px-4 py-2.5 hover:bg-slate-800/50 transition-all ' + (item.p ? 'opacity-40' : '');

        // Bloque fecha
        var dateBox = document.createElement('div');
        dateBox.className = 'flex-shrink-0 w-10 text-center';
        dateBox.innerHTML =
            '<p class="text-base font-black text-white leading-none">' + dt.getDate() + '</p>' +
            '<p class="text-[9px] font-bold text-slate-500 uppercase">' + MESES[dt.getMonth()].slice(0,3) + '</p>';

        // Separador
        var sep = document.createElement('div');
        sep.className = 'w-px h-8 bg-slate-800 flex-shrink-0';

        // Info concepto
        var info = document.createElement('div');
        info.className = 'flex-1 min-w-0';
        var name = document.createElement('p');
        name.className = 'text-xs font-bold text-slate-200 truncate ' + (item.p ? 'line-through' : '');
        name.textContent = item.c;
        var meta = document.createElement('p');
        meta.className = 'text-[9px] font-bold text-slate-600 uppercase tracking-wider mt-0.5';
        meta.textContent = r.tab;
        info.appendChild(name);
        info.appendChild(meta);

        // Monto
        var amt = document.createElement('div');
        amt.className = 'flex-shrink-0 text-right';
        var amtVal = document.createElement('p');
        amtVal.className = 'text-xs font-black font-mono ' + (item.p ? 'text-emerald-400' : 'text-blue-400');
        amtVal.textContent = '$' + parseFloat(item.m||0).toLocaleString('en-US',{minimumFractionDigits:2});
        // Estado
        var status = document.createElement('p');
        status.className = 'text-[9px] font-bold text-right mt-0.5 ' + (item.p ? 'text-emerald-600' : 'text-amber-500');
        status.textContent = item.p ? 'âœ” pagado' : 'â—‹ pendiente';
        amt.appendChild(amtVal);
        amt.appendChild(status);

        row.appendChild(dateBox);
        row.appendChild(sep);
        row.appendChild(info);
        row.appendChild(amt);
        listEl.appendChild(row);
    });
}

function showDayDetail(dateStr, rows) {
    var detail = document.getElementById('cal-detail');
    var title  = document.getElementById('cal-detail-title');
    var body   = document.getElementById('cal-detail-body');

    var dt = new Date(dateStr + 'T12:00:00');
    title.innerText = DIAS[dt.getDay()] + ' ' + dt.getDate() + ' de ' + MESES[dt.getMonth()] + ' ' + dt.getFullYear();

    body.innerHTML = '';

    if (!rows || rows.length === 0) {
        body.innerHTML = '<p class="text-center text-slate-600 italic text-xs py-3">Sin transacciones este dÃ­a</p>';
        detail.classList.remove('hidden');
        return;
    }

    var dayTotal = 0, dayPaid = 0;
    rows.forEach(function(r) { var v = parseFloat(r.item.m||0); dayTotal += v; if (r.item.p) dayPaid += v; });

    var summary = document.createElement('div');
    summary.className = 'flex gap-4 mb-3 p-3 bg-slate-900 rounded-2xl border border-slate-800';
    summary.innerHTML =
        '<div class="text-center flex-1"><p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Total</p><p class="font-black text-sm text-white font-mono">$' + dayTotal.toLocaleString('en-US',{minimumFractionDigits:2}) + '</p></div>' +
        '<div class="text-center flex-1 border-l border-slate-800"><p class="text-[9px] font-black text-emerald-500 uppercase tracking-widest">Pagado</p><p class="font-black text-sm text-emerald-400 font-mono">$' + dayPaid.toLocaleString('en-US',{minimumFractionDigits:2}) + '</p></div>' +
        '<div class="text-center flex-1 border-l border-slate-800"><p class="text-[9px] font-black text-blue-400 uppercase tracking-widest">Pendiente</p><p class="font-black text-sm text-blue-400 font-mono">$' + (dayTotal-dayPaid).toLocaleString('en-US',{minimumFractionDigits:2}) + '</p></div>';
    body.appendChild(summary);

    rows.forEach(function(r) {
        var item = r.item;
        var row  = document.createElement('div');
        row.className = 'flex items-center justify-between p-3 rounded-2xl border border-slate-800 transition-all ' + (item.p ? 'bg-emerald-900/10 opacity-50' : 'bg-slate-800/50 hover:bg-slate-800');
        var left = document.createElement('div');
        left.className = 'flex items-center gap-2 min-w-0';
        left.innerHTML = '<span class="text-sm flex-shrink-0">' + (item.p ? 'âœ…' : 'ðŸ”µ') + '</span>';
        var info2 = document.createElement('div');
        info2.className = 'min-w-0';
        info2.innerHTML = '<p class="font-bold text-xs text-slate-200 truncate ' + (item.p ? 'line-through' : '') + '">' + escVal(item.c) + '</p>' +
            '<p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mt-0.5">' + escVal(r.tab) + '</p>';
        left.appendChild(info2);
        var right = document.createElement('div');
        right.innerHTML = '<p class="font-black text-xs font-mono flex-shrink-0 ' + (item.p ? 'text-emerald-400' : 'text-blue-400') + '">$' + parseFloat(item.m||0).toLocaleString('en-US',{minimumFractionDigits:2}) + '</p>';
        row.appendChild(left); row.appendChild(right);
        body.appendChild(row);
    });

    detail.classList.remove('hidden');
    setTimeout(function() { detail.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 50);
}

function closeDayDetail() {
    calSelDay = null;
    document.getElementById('cal-detail').classList.add('hidden');
    renderCalendar();
}

// â”€â”€â”€ NOTIFICACIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Devuelve color y etiqueta segÃºn dÃ­as de diferencia
function getNotifStyle(diffDays) {
    if (diffDays <= 0)  return { color: '#ef4444', glow: 'rgba(239,68,68,0.4)',  label: 'HOY',         urgency: 7 };
    if (diffDays <= 3)  return { color: '#f87171', glow: 'rgba(248,113,113,0.35)', label: diffDays === 1 ? 'MAÃ‘ANA' : 'EN ' + diffDays + ' DÃAS', urgency: 6 };
    if (diffDays <= 7)  return { color: '#fb923c', glow: 'rgba(251,146,60,0.35)', label: 'EN ' + diffDays + ' DÃAS', urgency: 5 };
    if (diffDays <= 14) return { color: '#fbbf24', glow: 'rgba(251,191,36,0.3)',  label: 'EN ' + diffDays + ' DÃAS', urgency: 4 };
    if (diffDays <= 21) return { color: '#34d399', glow: 'rgba(52,211,153,0.3)',  label: 'EN ' + Math.ceil(diffDays/7) + ' SEMANAS', urgency: 3 };
    if (diffDays <= 45) return { color: '#60a5fa', glow: 'rgba(96,165,250,0.3)',  label: 'EN ~1 MES',   urgency: 2 };
    return                     { color: '#a78bfa', glow: 'rgba(167,139,250,0.25)', label: 'EN +2 MESES', urgency: 1 };
}

function buildNotifList() {
    if (!localData || !localData.db) return [];

    var now      = new Date();
    var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
    var todayMs  = new Date(todayStr + 'T00:00:00').getTime();

    var notifs = [];

    Object.keys(localData.db).forEach(function(tab) {
        (localData.db[tab] || []).forEach(function(item) {
            if (!item.f || item.p) return;           // sin fecha o ya pagado â†’ ignorar
            var itemMs   = new Date(item.f + 'T00:00:00').getTime();
            var diffDays = Math.round((itemMs - todayMs) / 86400000);
            if (diffDays < 0) return;                // fechas pasadas no van en notificaciones
            notifs.push({ tab: tab, item: item, diffDays: diffDays, dateMs: itemMs });
        });
    });

    // Ordenar: primero los mÃ¡s cercanos
    notifs.sort(function(a, b) { return a.dateMs - b.dateMs; });
    return notifs;
}

function renderNotifDrawer() {
    var notifs   = buildNotifList();
    var listEl   = document.getElementById('notif-list');
    var emptyEl  = document.getElementById('notif-empty');
    var badge    = document.getElementById('notif-bell-badge');
    var totalEl  = document.getElementById('notif-total-count');

    // Badge en el botÃ³n
    var urgent = notifs.filter(function(n) { return n.diffDays <= 3; }).length;
    if (urgent > 0) {
        badge.textContent = urgent;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
    totalEl.textContent = notifs.length + ' pendientes';

    // Limpiar lista (dejar el empty placeholder)
    var children = Array.prototype.slice.call(listEl.children);
    children.forEach(function(c) { if (c.id !== 'notif-empty') c.remove(); });

    if (notifs.length === 0) {
        emptyEl.style.display = 'flex';
        return;
    }
    emptyEl.style.display = 'none';

    // Agrupar por secciÃ³n de urgencia para separadores
    var lastUrgency = null;
    var sectionLabels = { 7: 'ðŸ”´ Hoy', 6: 'ðŸ”´ PrÃ³ximos 3 dÃ­as', 5: 'ðŸŸ  Esta semana', 4: 'ðŸŸ¡ PrÃ³ximas 2 semanas', 3: 'ðŸŸ¢ PrÃ³ximas 3 semanas', 2: 'ðŸ”µ PrÃ³ximo mes', 1: 'ðŸŸ£ MÃ¡s adelante' };

    notifs.forEach(function(n) {
        var style    = getNotifStyle(n.diffDays);
        var item     = n.item;

        // Separador de secciÃ³n
        if (style.urgency !== lastUrgency) {
            lastUrgency = style.urgency;
            var sep = document.createElement('div');
            sep.className = 'px-5 py-2 bg-slate-900/40';
            sep.innerHTML = '<p class="text-[9px] font-black uppercase tracking-widest text-slate-500">' + (sectionLabels[style.urgency] || '') + '</p>';
            listEl.appendChild(sep);
        }

        var row = document.createElement('div');
        row.className = 'flex items-center gap-3 px-5 py-3.5 hover:bg-slate-800/40 transition-all cursor-default';

        // Dot con glow
        var dot = document.createElement('div');
        dot.className = 'notif-dot flex-shrink-0';
        dot.style.background = style.color;
        dot.style.color      = style.color;
        dot.style.boxShadow  = '0 0 8px ' + style.glow;

        // Info
        var info = document.createElement('div');
        info.className = 'flex-1 min-w-0';

        var nameRow = document.createElement('div');
        nameRow.className = 'flex items-center gap-2';
        var name = document.createElement('p');
        name.className = 'text-sm font-bold text-slate-200 truncate';
        name.textContent = item.c;
        nameRow.appendChild(name);

        var tabBadge = document.createElement('span');
        tabBadge.className = 'text-[8px] font-black uppercase tracking-widest bg-slate-800 text-slate-500 border border-slate-700 px-1.5 py-0.5 rounded flex-shrink-0';
        tabBadge.textContent = n.tab;
        nameRow.appendChild(tabBadge);

        var meta = document.createElement('div');
        meta.className = 'flex items-center gap-2 mt-0.5';

        var dateLabel = document.createElement('p');
        dateLabel.className = 'text-[10px] font-bold font-mono';
        dateLabel.style.color = style.color;
        // Formatear fecha legible
        var dt = new Date(item.f + 'T12:00:00');
        dateLabel.textContent = DIAS[dt.getDay()].slice(0,3) + ' ' + dt.getDate() + ' ' + MESES[dt.getMonth()].slice(0,3) + ' ' + dt.getFullYear();

        var urgLabel = document.createElement('span');
        urgLabel.className = 'text-[9px] font-black uppercase tracking-widest text-slate-600';
        urgLabel.textContent = 'Â· ' + style.label;

        meta.appendChild(dateLabel);
        meta.appendChild(urgLabel);

        info.appendChild(nameRow);
        info.appendChild(meta);

        // Monto
        var amtWrap = document.createElement('div');
        amtWrap.className = 'flex-shrink-0 text-right';
        var amt = document.createElement('p');
        amt.className = 'text-sm font-black font-mono text-white';
        amt.textContent = '$' + parseFloat(item.m||0).toLocaleString('en-US',{minimumFractionDigits:2});
        amtWrap.appendChild(amt);

        row.appendChild(dot);
        row.appendChild(info);
        row.appendChild(amtWrap);
        listEl.appendChild(row);
    });
}

function openNotifDrawer() {
    renderNotifDrawer();
    document.getElementById('notif-drawer').classList.add('open');
    document.getElementById('notif-overlay').classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closeNotifDrawer() {
    document.getElementById('notif-drawer').classList.remove('open');
    document.getElementById('notif-overlay').classList.remove('open');
    document.body.style.overflow = '';
}

// â”€â”€â”€ MODAL BACKDROP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('edit-profile-modal').addEventListener('click', function(e) {
    if (e.target === this) toggleProfileOptions(false);
});
</script>
</body>
</html>
